{% extends "layouts/" + theme_layout + ".html" %}

{% block title %}Submit Message - Atacama{% endblock %}

{% block page_title %}
<h1 class="site-title">Submit Message</h1>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/css/blog/submit.css">
{% endblock %}

{% block content %}
<div class="container">
    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}

    <form method="POST" action="/admin/submit">
        <div class="form-group">
            <label for="subject">Subject:</label>
            <input type="text" id="subject" name="subject" required>
        </div>

        {% if channels %}
        <div class="form-group">
            <label for="channel">Channel:</label>
            <select name="channel" id="channel" required>
                {% for name, config in channels.items() %}
                    <option value="{{ name }}"{% if name == default_channel %} selected{% endif %}>
                        {{ config.get_display_name() }} - {{ config.description }}
                        {% if config.requires_auth %}(Private){% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="parent_id">Parent Message (optional):</label>
            <select name="parent_id" id="parent_id">
                <option value="">No parent message</option>
                {% for message in recent_messages %}
                    <option value="{{ message.id }}"
                            data-channel="{{ message.channel or '' }}"
                            data-subject="{{ message.subject or '' }}">
                        {{ message.subject or '(No Subject)' }}
                        {% if message.author %} by {{ message.author.name }}{% endif %}
                        - ID: {{ message.id }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="content">Content:</label>
            <textarea id="content" name="content" rows="10" required></textarea>
            <div class="preview-controls">
                <button type="button" id="previewButton" class="button secondary">Preview</button>
            </div>
        </div>

        <div id="previewArea" class="message-preview" style="display: none;">
            <h3>Preview</h3>
            <div id="previewContent" class="message-body">
                <div class="message-main"></div>
                <div class="message-sidebar"></div>
            </div>
        </div>
        
        <button type="submit" class="button">Submit</button>
    </form>
    
    <div class="info-box">
        <h3>Formatting Help</h3>
        <p>You can use the following formatting options in your message:</p>
        <ul>
            <li><strong>Bold</strong>: Use <code>*text*</code></li>
            <li><em>Literal Text</em>: Use <code>&lt;&lt; text &gt;&gt;</code>
            <li><b>Read More</b>: Use <code>--MORE--</code></li>
            <!-- Add more formatting options as needed -->
        </ul>
    </div>
    {% if colors %}
    <div class="info-box">
        <h3>Color Tags</h3>
        <p>You can use the following color tags in your message:</p>
        <ul>
            {% for color_name, (sigil, class_name, description) in colors.items() %}
            <li><code>&lt;{{ color_name }}&gt;</code> {{ sigil }} - <span class="color-{{ class_name }}">{{ description }}</span></li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Handle parent message selection - update channel and subject
    document.getElementById('parent_id')?.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (!selectedOption.value) {
            // "No parent message" selected - don't change anything
            return;
        }

        const parentChannel = selectedOption.dataset.channel;
        const parentSubject = selectedOption.dataset.subject;

        // Update channel dropdown
        if (parentChannel) {
            const channelSelect = document.getElementById('channel');
            if (channelSelect) {
                // Find and select the matching channel option
                for (let i = 0; i < channelSelect.options.length; i++) {
                    if (channelSelect.options[i].value === parentChannel) {
                        channelSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        }

        // Update subject with incremented part number
        if (parentSubject) {
            const subjectInput = document.getElementById('subject');
            if (subjectInput) {
                subjectInput.value = incrementPartNumber(parentSubject);
            }
        }
    });

    /**
     * Increment the part/sequence number in a subject string.
     * Handles patterns like:
     *   - (Part ##) or (part ##) - case insensitive
     *   - , part ##
     *   - (##/##) - format like (1/5), (2/5), etc.
     * If no pattern found, adds "(part 2)" at the end.
     */
    function incrementPartNumber(subject) {
        // Pattern 1: (Part ##) or (part ##) - case insensitive
        const partPattern = /\(([pP]art)\s+(\d+)\)/;
        let match = subject.match(partPattern);
        if (match) {
            const partWord = match[1];
            const num = parseInt(match[2], 10) + 1;
            return subject.replace(partPattern, `(${partWord} ${num})`);
        }

        // Pattern 2: , part ## (with comma prefix)
        const commaPartPattern = /,\s*part\s+(\d+)/i;
        match = subject.match(commaPartPattern);
        if (match) {
            const num = parseInt(match[1], 10) + 1;
            return subject.replace(commaPartPattern, `, part ${num}`);
        }

        // Pattern 3: (##/##) - sequence format like (1/5)
        const sequencePattern = /\((\d+)\/(\d+)\)/;
        match = subject.match(sequencePattern);
        if (match) {
            const currentNum = parseInt(match[1], 10) + 1;
            const totalNum = match[2];
            return subject.replace(sequencePattern, `(${currentNum}/${totalNum})`);
        }

        // No pattern found - add "(part 2)" at the end
        return subject.trim() + ' (part 2)';
    }

    document.getElementById('previewButton')?.addEventListener('click', async function() {
        const content = document.getElementById('content').value;
        const previewArea = document.getElementById('previewArea');
        const previewContent = document.getElementById('previewContent').querySelector('.message-main');

        try {
            const response = await fetch('/admin/api/preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });

            if (!response.ok) {
                throw new Error('Preview request failed');
            }

            const data = await response.json();
            previewContent.innerHTML = data.processed_content;
            previewArea.style.display = 'block';

            // Initialize Atacama viewer for preview content
            const viewer = new AtacamaViewer();
            viewer.initialize();
        } catch (error) {
            console.error('Preview error:', error);
            previewContent.innerHTML = '<div class="error">Error generating preview</div>';
            previewArea.style.display = 'block';
        }
    });
</script>
{% endblock %}