{% extends "trakaido/base_stats.html" %}
{% block content %}
<style>
  .back { font-size: 13px; }
  .field { margin-bottom: 12px; }
  .field > label:first-child { display: block; font-size: 13px; font-weight: 600; margin-bottom: 4px; color: var(--muted); }
  .field input[type=email] { width: 100%; max-width: 400px; padding: 8px 12px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px; box-sizing: border-box; }
  .radio { font-size: 14px; margin-right: 16px; cursor: pointer; }
  .btn-primary { padding: 8px 20px; background: var(--accent); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
  .btn-primary:hover { opacity: 0.88; }
  .btn-remove { padding: 4px 12px; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 6px; cursor: pointer; font-size: 13px; }
  .btn-remove:hover { background: #f1aeb5; }
  .msg { margin-top: 10px; padding: 8px 12px; border-radius: 8px; font-size: 13px; }
  .msg.ok { background: #d4edda; color: #155724; }
  .msg.err { background: #f8d7da; color: #721c24; }
</style>

<p class="back muted"><a href="/api/trakaido/admin/classrooms">‚Üê All classrooms</a></p>

<div class="section-head">
  <h1>
    {{ classroom.name }}
    {% if classroom.archived %}<span class="pill">Archived</span>{% endif %}
  </h1>
</div>

<div class="card">
  <div class="section-head" style="margin-bottom:12px;">
    <h2 style="margin:0;">Members</h2>
    <span class="pill">{{ members|length }} total</span>
  </div>
  <table id="members-table">
    <thead>
      <tr>
        <th>Name / Email</th>
        <th>Role</th>
        <th>Joined</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for m in members %}
      <tr>
        <td>
          <strong>{{ m.name }}</strong>
          {% if m.name != m.email %}<br><span class="muted">{{ m.email }}</span>{% endif %}
        </td>
        <td><span class="pill">{{ m.role }}</span></td>
        <td class="muted">{{ m.joinedAt }}</td>
        <td>
          <button class="btn-remove" data-email="{{ m.email }}" data-name="{{ m.name }}">Remove</button>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="4" class="muted">No members yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div id="rm-msg" class="msg" hidden></div>
</div>

<div class="card">
  <h2>Add member</h2>
  <form id="add-form">
    <div class="field">
      <label for="email">Email address</label>
      <input type="email" id="email" name="email" required placeholder="student@example.com">
    </div>
    <div class="field">
      <label>Role</label><br>
      <label class="radio"><input type="radio" name="role" value="member" checked> Member</label>
      <label class="radio"><input type="radio" name="role" value="manager"> Manager</label>
    </div>
    <button type="submit" class="btn-primary">Add member</button>
  </form>
  <div id="add-msg" class="msg" hidden></div>
</div>

<script>
const CLASSROOM_ID = {{ classroom.id }};

document.getElementById('add-form').addEventListener('submit', async function (e) {
  e.preventDefault();
  const msg = document.getElementById('add-msg');
  msg.hidden = true;

  const role = this.querySelector('input[name=role]:checked').value;
  const res = await fetch('/api/trakaido/admin/classrooms/' + CLASSROOM_ID + '/members', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: this.email.value.trim(), role }),
  });
  const data = await res.json();

  if (res.ok) {
    msg.className = 'msg ok';
    msg.textContent = 'Added ' + data.member.email + ' as ' + data.member.role + '.';
    msg.hidden = false;
    setTimeout(() => window.location.reload(), 800);
  } else {
    msg.className = 'msg err';
    msg.textContent = data.error || 'Unknown error';
    msg.hidden = false;
  }
});

document.addEventListener('click', async function (e) {
  if (!e.target.matches('.btn-remove')) return;
  const email = e.target.dataset.email;
  const name = e.target.dataset.name;
  if (!confirm('Remove ' + name + ' from this classroom?')) return;

  const msg = document.getElementById('rm-msg');
  msg.hidden = true;

  const res = await fetch('/api/trakaido/admin/classrooms/' + CLASSROOM_ID + '/members/remove', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email }),
  });
  const data = await res.json();

  if (res.ok) {
    msg.className = 'msg ok';
    msg.textContent = 'Removed ' + email + '.';
    msg.hidden = false;
    setTimeout(() => window.location.reload(), 600);
  } else {
    msg.className = 'msg err';
    msg.textContent = data.error || 'Unknown error';
    msg.hidden = false;
  }
});
</script>
{% endblock %}
