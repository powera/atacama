{% extends "trakaido/base_stats.html" %}
{% block content %}
<div class="section-head">
  <h1>{{ classroom.name }} · {{ member.name }} · {{ language_display_name }}</h1>
  <a href="/api/trakaido/classrooms/{{ classroom.id }}/members">← Back to members</a>
</div>
<div class="grid card">
  <div class="metric"><div class="muted">Words known</div><strong>{{ summary.wordsKnown }}</strong></div>
  <div class="metric"><div class="muted">Words exposed</div><strong>{{ summary.wordsExposed }}</strong></div>
  <div class="metric"><div class="muted">Words tracked</div><strong>{{ summary.wordsTracked }}</strong></div>
  <div class="metric"><div class="muted">All-time answered</div><strong>{{ summary.activitySummary.combined.totalAnswered }}</strong></div>
</div>
<div class="card">
  <h2>Questions answered per day (past 30 days)</h2>
  <p class="muted">Day-level totals only; exact practice times are intentionally hidden.</p>
  {% if monthly_questions_series %}
    <div id="daily-questions-chart" style="width:100%; height:260px;"></div>
    <script src="/api/trakaido/js/third_party/react.production.min.js"></script>
    <script src="/api/trakaido/js/third_party/react-dom.production.min.js"></script>
    <script src="/api/trakaido/js/third_party/prop-types.min.js"></script>
    <script src="/api/trakaido/js/third_party/Recharts.js"></script>
    <script>
      (function renderDailyQuestionsChart() {
        const data = {{ monthly_questions_series | tojson }};
        const chartData = data.map((point) => ({
          date: point.date,
          dayLabel: point.dayLabel,
          questionsAnswered: point.questionsAnswered,
          tooltipLabel: `${point.date}: ${point.questionsAnswered} questions`,
        }));

        const chartRoot = document.getElementById("daily-questions-chart");
        if (!chartRoot || !Array.isArray(chartData) || !chartData.length) {
          return;
        }

        const maxQuestions = chartData.reduce(
          (maxValue, point) => Math.max(maxValue, point.questionsAnswered || 0),
          0,
        );
        const yAxisMax = Math.max(1, maxQuestions);
        const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip } = Recharts;

        ReactDOM.createRoot(chartRoot).render(
          React.createElement(
            ResponsiveContainer,
            { width: "100%", height: "100%" },
            React.createElement(
              BarChart,
              { data: chartData, margin: { top: 8, right: 24, left: 0, bottom: 8 } },
              React.createElement(CartesianGrid, { strokeDasharray: "3 3", stroke: "#dde3ee" }),
              React.createElement(XAxis, {
                dataKey: "dayLabel",
                interval: 4,
                tick: { fill: "#5e6b87", fontSize: 11 },
              }),
              React.createElement(YAxis, {
                allowDecimals: false,
                domain: [0, yAxisMax],
                tick: { fill: "#5e6b87", fontSize: 11 },
              }),
              React.createElement(Tooltip, {
                formatter: (value) => [`${value} questions`, "Answered"],
                labelFormatter: (_label, payload) =>
                  payload && payload.length ? payload[0].payload.date : "",
              }),
              React.createElement(Bar, {
                dataKey: "questionsAnswered",
                fill: "#3669f7",
                radius: [4, 4, 0, 0],
                isAnimationActive: false,
              }),
            ),
          ),
        );
      })();
    </script>
  {% else %}
    <p class="muted">No daily activity yet.</p>
  {% endif %}
</div>
<div class="card">
  <h2>Period overview</h2>
  <table>
    <thead><tr><th>Period</th><th>Newly exposed</th><th>Total exposed</th><th>Current day</th><th>Compared with</th></tr></thead>
    <tbody>
      <tr><td>Daily</td><td>+{{ daily.progress.exposed.new if daily.progress is defined else 0 }}</td><td>{{ daily.progress.exposed.total if daily.progress is defined else 0 }}</td><td>{{ daily.currentDay }}</td><td>Yesterday ({{ daily.targetBaselineDay if daily.targetBaselineDay is defined else '-' }})</td></tr>
      <tr><td>Weekly</td><td>+{{ weekly.progress.exposed.new if weekly.progress is defined else 0 }}</td><td>{{ weekly.progress.exposed.total if weekly.progress is defined else 0 }}</td><td>{{ weekly.currentDay }}</td><td>{{ weekly.actualBaselineDay if weekly.actualBaselineDay is defined else '-' }}</td></tr>
      <tr><td>Monthly</td><td>+{{ monthly.monthlyAggregate.exposed.new if monthly.monthlyAggregate is defined else 0 }}</td><td>{{ monthly.monthlyAggregate.exposed.total if monthly.monthlyAggregate is defined else 0 }}</td><td>{{ monthly.currentDay }}</td><td>{{ monthly.actualBaselineDay if monthly.actualBaselineDay is defined else '-' }}</td></tr>
    </tbody>
  </table>
</div>
<div class="card">
  <h2>Ten most recent words</h2>
  {% if recent_words %}
    <table>
      <thead><tr><th>Word</th><th>GUID</th><th>Last seen (UTC day)</th><th>Total answers</th></tr></thead>
      <tbody>
      {% for row in recent_words %}
        <tr><td>{{ row.wordLabel }}</td><td><code>{{ row.wordKey }}</code></td><td>{{ row.lastSeenDay }}</td><td>{{ row.totalAnswered }}</td></tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">No recent words yet.</p>
  {% endif %}
</div>
{% endblock %}
