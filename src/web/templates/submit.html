<!DOCTYPE html>
<html>
<head>
    <title>Submit Message - Atacama</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/submit.css">
    <link rel="stylesheet" href="/css/atacama.css">
    <script src="/js/atacama.js"></script>
</head>
<body>
    <div class="container">
        <h1>Submit Message</h1>
        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}
        {% if success %}
        <div class="success-container">
            <div class="success">Message submitted successfully!</div>
            {% if view_url %}
            <a href="{{ view_url }}" class="view-link">View Message â†’</a>
            {% endif %}
        </div>
        {% endif %}
        
        <form method="POST" action="/submit">
            <div class="form-group">
                <label for="subject">Subject:</label>
                <input type="text" id="subject" name="subject" required>
            </div>

            <div class="form-group">
                <label for="channel">Channel:</label>
                <select name="channel" id="channel" required>
                    {% for name, config in channels.items() %}
                        <option value="{{ name }}"{% if name == default_channel %} selected{% endif %}>
                            {{ name|title }} - {{ config.description }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="parent_id">Parent Message (optional):</label>
                <select name="parent_id" id="parent_id">
                    <option value="">No parent message</option>
                    {% for message in recent_messages %}
                        <option value="{{ message.id }}">
                            {{ message.subject or '(No Subject)' }} - ID: {{ message.id }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="content">Content:</label>
                <textarea id="content" name="content" rows="10" required></textarea>
                <div class="preview-controls">
                    <button type="button" id="previewButton" class="secondary">Preview</button>
                </div>
            </div>

            <div id="previewArea" class="message-preview" style="display: none;">
                <h3>Preview</h3>
                <div id="previewContent" class="message-body">
                    <div class="message-main"></div>
                    <div class="message-sidebar"></div>
                </div>
            </div>
            
            <button type="submit">Submit</button>
        </form>
       
        {% if colors %}
        <div class="info-box">
            <h3>Color Tags</h3>
            <p>You can use the following color tags in your message:</p>
            <ul>
                {% for color_name, (sigil, class_name, description) in colors.items() %}
                <li><code>&lt;{{ color_name }}&gt;</code> {{ sigil }} - <span class="color-{{ class_name }}">{{ description }}</span></li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <script>
        document.getElementById('previewButton').addEventListener('click', async function() {
            const content = document.getElementById('content').value;
            const previewArea = document.getElementById('previewArea');
            const previewContent = document.getElementById('previewContent').querySelector('.message-main');

            try {
                const response = await fetch('/api/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });

                if (!response.ok) {
                    throw new Error('Preview request failed');
                }

                const data = await response.json();
                previewContent.innerHTML = data.processed_content;
                previewArea.style.display = 'block';

                new AtacamaViewer().initialize(); 
            } catch (error) {
                console.error('Preview error:', error);
                previewContent.innerHTML = '<div class="error">Error generating preview</div>';
                previewArea.style.display = 'block';
            }
        });
    </script>
</body>
</html>
