{% extends "layouts/" + theme_layout + ".html" %}

{% block title %}Improve Widget: {{ widget.title }} - Atacama{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static.serve_css', filename='improve_widget.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <h1>Improve Widget: {{ widget.title }}</h1>

    <div class="improvement-header">
        <a href="{{ url_for('widgets.edit_widget', slug=widget.slug) }}" class="button secondary">Back to Edit</a>
        <a href="{{ url_for('widgets.view_widget', slug=widget.slug) }}" class="button">View Widget</a>
    </div>

    <div class="improvement-workflow">
        <!-- Version Selection -->
        <div class="version-selection">
            <h3>Starting Version</h3>
            <select id="base-version" name="base_version">
                <option value="current">Current Code ({{ widget.title }})</option>
                {% for version in widget.versions %}
                    <option value="{{ version.id }}" 
                            {% if version.id == widget.active_version_id %}selected{% endif %}>
                        Version {{ version.version_number }} 
                        {% if version.improvement_type %}({{ version.improvement_type }}){% endif %}
                        - {{ version.created_at.strftime('%m/%d %H:%M') }}
                        {% if not version.is_working %} ‚ö†Ô∏è{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Improvement Options -->
        <div class="improvement-options">
            <h3>Improvement Type</h3>

            <!-- Canned Actions -->
            <div class="canned-actions">
                <h4>Quick Improvements</h4>
                <div class="action-buttons">
                    <button type="button" class="button canned-action" 
                            data-type="fullscreen" 
                            data-prompt="Improve this React widget to work better in full-screen mode...">
                        üì± Better Full-Screen Mode
                    </button>
                    <button type="button" class="button canned-action" 
                            data-type="global_settings" 
                            data-prompt="Enhance this React widget to support global application settings...">
                        üé® Global Settings Support
                    </button>
                    <button type="button" class="button canned-action" 
                            data-type="accessibility" 
                            data-prompt="Improve the accessibility of this React widget...">
                        ‚ôø Accessibility Improvements
                    </button>
                    <button type="button" class="button canned-action" 
                            data-type="mobile" 
                            data-prompt="Optimize this React widget for mobile devices...">
                        üì± Mobile Optimization
                    </button>
                </div>
            </div>

            <!-- Custom Prompt -->
            <div class="custom-prompt">
                <h4>Custom Improvement</h4>
                <textarea id="custom-prompt" rows="4" 
                          placeholder="Describe how you'd like to improve this widget..."></textarea>
                <button type="button" class="button primary" onclick="improveWidget('custom')">
                    üöÄ Improve Widget
                </button>
            </div>
        </div>

        <!-- Progress Area -->
        <div id="improvement-progress" class="improvement-progress" style="display: none;">
            <h3>Processing...</h3>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <p id="progress-text">Analyzing widget code...</p>
        </div>

        <!-- Results Area -->
        <div id="improvement-results" class="improvement-results" style="display: none;">
            <h3>Improvement Results</h3>
            <div class="results-content">
                <div class="result-actions">
                    <button type="button" class="button primary" onclick="saveVersion()">
                        üíæ Save This Version
                    </button>
                    <button type="button" class="button secondary" onclick="compareCode()">
                        üìä Compare Changes
                    </button>
                    <button type="button" class="button" onclick="testVersion()">
                        üß™ Test Version
                    </button>
                </div>
                <div class="code-preview">
                    <h4>Improved Code:</h4>
                    <textarea id="improved-code" rows="20" readonly></textarea>
                </div>
                <div class="ai-notes">
                    <h4>AI Notes:</h4>
                    <div id="ai-response"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Code Comparison Modal -->
<div id="compare-modal" class="modal" style="display: none;">
    <div class="modal-content diff-modal">
        <div class="modal-header">
            <h2>Code Comparison</h2>
            <span class="close" onclick="closeCompare()">&times;</span>
        </div>
        <div class="diff-toolbar">
            <button type="button" class="button secondary" onclick="toggleDiffMode()">
                <span id="diff-mode-text">Switch to Unified View</span>
            </button>
            <div class="diff-stats">
                <span id="diff-stats-text">Computing changes...</span>
            </div>
        </div>
        <div class="diff-container">
            <div id="side-by-side-view" class="diff-view active">
                <div class="diff-pane">
                    <div class="diff-header">
                        <h3>Original Code</h3>
                        <span class="line-count" id="original-line-count"></span>
                    </div>
                    <div class="diff-content">
                        <div class="line-numbers" id="original-line-numbers"></div>
                        <pre class="code-content" id="original-code-content"></pre>
                    </div>
                </div>
                <div class="diff-pane">
                    <div class="diff-header">
                        <h3>Improved Code</h3>
                        <span class="line-count" id="improved-line-count"></span>
                    </div>
                    <div class="diff-content">
                        <div class="line-numbers" id="improved-line-numbers"></div>
                        <pre class="code-content" id="improved-code-content"></pre>
                    </div>
                </div>
            </div>
            <div id="unified-view" class="diff-view">
                <div class="diff-pane unified">
                    <div class="diff-header">
                        <h3>Unified Diff</h3>
                    </div>
                    <div class="diff-content">
                        <div class="line-numbers" id="unified-line-numbers"></div>
                        <pre class="code-content" id="unified-code-content"></pre>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fallback textareas for copy functionality -->
        <textarea id="original-code" style="display: none;" readonly></textarea>
        <textarea id="comparison-improved-code" style="display: none;" readonly></textarea>
    </div>
</div>

<!-- Version Save Modal -->
<div id="save-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeSave()">&times;</span>
        <h2>Save Version</h2>
        <form id="save-version-form">
            <div class="form-group">
                <label for="dev-comments">Developer Comments:</label>
                <textarea id="dev-comments" name="dev_comments" rows="3" 
                          placeholder="Notes about this version..."></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="set-active" name="set_active">
                    Set as active version
                </label>
            </div>
            <div class="form-actions">
                <button type="button" class="button primary" onclick="confirmSave()">Save Version</button>
                <button type="button" class="button secondary" onclick="closeSave()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentImprovedCode = '';
    let currentPrompt = '';
    let currentType = '';
    let originalCode = '';

    // Set up canned action buttons
    document.querySelectorAll('.canned-action').forEach(button => {
        button.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            const prompt = this.getAttribute('data-prompt');
            improveWidget(type, prompt);
        });
    });

    function getSelectedVersionCode() {
        const versionSelect = document.getElementById('base-version');
        const selectedValue = versionSelect.value;

        // This will be fetched from server when needed instead of embedded here
        return new Promise((resolve, reject) => {
            fetch('{{ url_for("widgets.get_version_code", slug=widget.slug) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    version: selectedValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resolve(data.code);
                } else {
                    reject(new Error(data.error || 'Failed to get version code'));
                }
            })
            .catch(error => reject(error));
        });
    }

    function improveWidget(type, prompt = null) {
        currentType = type;

        if (type === 'custom') {
            prompt = document.getElementById('custom-prompt').value;
            if (!prompt.trim()) {
                alert('Please enter a description of how to improve the widget.');
                return;
            }
        }

        currentPrompt = prompt;

        // Add processing state to disable interactions
        document.body.classList.add('processing');

        // Show progress
        document.getElementById('improvement-progress').style.display = 'block';
        document.getElementById('improvement-progress').classList.add('processing');
        document.getElementById('improvement-results').style.display = 'none';

        // Update progress text
        const progressText = document.getElementById('progress-text');
        const progressFill = document.querySelector('.progress-fill');

        progressText.textContent = 'Getting version code...';
        progressFill.style.width = '10%';

        // Get the selected version code first
        getSelectedVersionCode()
            .then(code => {
                originalCode = code;

                progressText.textContent = 'Sending request to AI...';
                progressFill.style.width = '30%';

                setTimeout(() => {
                    progressText.textContent = 'AI is analyzing and improving code...';
                    progressFill.style.width = '70%';
                }, 1000);

                // Make the improvement request
                return fetch('{{ url_for("widgets.improve_widget", slug=widget.slug) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        base_version: document.getElementById('base-version').value,
                        prompt: prompt,
                        improvement_type: type
                    })
                });
            })
            .then(response => response.json())
            .then(data => {
                progressText.textContent = 'Processing results...';
                progressFill.style.width = '100%';

                setTimeout(() => {
                    showResults(data);
                }, 500);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to improve widget: ' + error.message);
                document.getElementById('improvement-progress').style.display = 'none';
                // Remove processing state on error
                document.body.classList.remove('processing');
            });
    }

    function showResults(data) {
        // Remove processing state
        document.body.classList.remove('processing');
        
        document.getElementById('improvement-progress').style.display = 'none';
        document.getElementById('improvement-results').style.display = 'block';

        if (data.success) {
            currentImprovedCode = data.improved_code;
            document.getElementById('improved-code').value = data.improved_code;
            
            // Properly escape HTML content
            const aiModel = escapeHtml(data.ai_model || 'OpenAI');
            const improvementType = escapeHtml(currentType);
            const fullResponse = data.full_response ? escapeHtml(data.full_response) : '';
            
            document.getElementById('ai-response').innerHTML = `
                <p><strong>Improvement successful!</strong></p>
                <p>AI used: ${aiModel}</p>
                <p>Type: ${improvementType}</p>
                ${fullResponse ? `<details><summary>Full AI Response</summary><pre>${fullResponse}</pre></details>` : ''}
            `;
        } else {
            const errorMessage = escapeHtml(data.error || 'Unknown error');
            document.getElementById('ai-response').innerHTML = `
                <p><strong>Error:</strong> ${errorMessage}</p>
                <p>The original code has been preserved.</p>
            `;
            currentImprovedCode = originalCode;
            document.getElementById('improved-code').value = originalCode;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function compareCode() {
        document.getElementById('original-code').value = originalCode;
        document.getElementById('comparison-improved-code').value = currentImprovedCode;
        
        // Generate and display the diff
        generateDiff(originalCode, currentImprovedCode);
        
        document.getElementById('compare-modal').style.display = 'block';
    }

    function generateDiff(originalText, improvedText) {
        const originalLines = originalText.split('\n');
        const improvedLines = improvedText.split('\n');
        
        // Simple line-by-line diff implementation
        const diff = computeLineDiff(originalLines, improvedLines);
        
        // Update side-by-side view
        updateSideBySideView(diff);
        
        // Update unified view
        updateUnifiedView(diff);
        
        // Update stats
        updateDiffStats(diff);
    }

    function computeLineDiff(originalLines, improvedLines) {
        const diff = [];
        let originalIndex = 0;
        let improvedIndex = 0;
        
        while (originalIndex < originalLines.length || improvedIndex < improvedLines.length) {
            const originalLine = originalLines[originalIndex];
            const improvedLine = improvedLines[improvedIndex];
            
            if (originalIndex >= originalLines.length) {
                // Only improved lines left
                diff.push({ type: 'added', improved: improvedLine, improvedLineNum: improvedIndex + 1 });
                improvedIndex++;
            } else if (improvedIndex >= improvedLines.length) {
                // Only original lines left
                diff.push({ type: 'removed', original: originalLine, originalLineNum: originalIndex + 1 });
                originalIndex++;
            } else if (originalLine === improvedLine) {
                // Lines are the same
                diff.push({ 
                    type: 'unchanged', 
                    original: originalLine, 
                    improved: improvedLine,
                    originalLineNum: originalIndex + 1,
                    improvedLineNum: improvedIndex + 1
                });
                originalIndex++;
                improvedIndex++;
            } else {
                // Lines are different - simple heuristic: treat as changed
                diff.push({ 
                    type: 'changed', 
                    original: originalLine, 
                    improved: improvedLine,
                    originalLineNum: originalIndex + 1,
                    improvedLineNum: improvedIndex + 1
                });
                originalIndex++;
                improvedIndex++;
            }
        }
        
        return diff;
    }

    function updateSideBySideView(diff) {
        const originalLineNumbers = document.getElementById('original-line-numbers');
        const originalCodeContent = document.getElementById('original-code-content');
        const improvedLineNumbers = document.getElementById('improved-line-numbers');
        const improvedCodeContent = document.getElementById('improved-code-content');
        
        let originalHTML = '';
        let improvedHTML = '';
        let originalLineNumHTML = '';
        let improvedLineNumHTML = '';
        
        diff.forEach(item => {
            if (item.type === 'unchanged' || item.type === 'changed') {
                // Both sides have content
                const originalClass = item.type === 'changed' ? 'line-removed' : '';
                const improvedClass = item.type === 'changed' ? 'line-added' : '';
                
                originalLineNumHTML += `<div class="line-num ${originalClass}">${item.originalLineNum || ''}</div>`;
                originalHTML += `<div class="code-line ${originalClass}">${escapeHtml(item.original || '')}</div>`;
                
                improvedLineNumHTML += `<div class="line-num ${improvedClass}">${item.improvedLineNum || ''}</div>`;
                improvedHTML += `<div class="code-line ${improvedClass}">${escapeHtml(item.improved || '')}</div>`;
            } else if (item.type === 'removed') {
                // Only original side has content
                originalLineNumHTML += `<div class="line-num line-removed">${item.originalLineNum}</div>`;
                originalHTML += `<div class="code-line line-removed">${escapeHtml(item.original)}</div>`;
                
                improvedLineNumHTML += `<div class="line-num line-empty"></div>`;
                improvedHTML += `<div class="code-line line-empty"></div>`;
            } else if (item.type === 'added') {
                // Only improved side has content
                originalLineNumHTML += `<div class="line-num line-empty"></div>`;
                originalHTML += `<div class="code-line line-empty"></div>`;
                
                improvedLineNumHTML += `<div class="line-num line-added">${item.improvedLineNum}</div>`;
                improvedHTML += `<div class="code-line line-added">${escapeHtml(item.improved)}</div>`;
            }
        });
        
        originalLineNumbers.innerHTML = originalLineNumHTML;
        originalCodeContent.innerHTML = originalHTML;
        improvedLineNumbers.innerHTML = improvedLineNumHTML;
        improvedCodeContent.innerHTML = improvedHTML;
        
        // Update line counts
        document.getElementById('original-line-count').textContent = `${diff.filter(d => d.original).length} lines`;
        document.getElementById('improved-line-count').textContent = `${diff.filter(d => d.improved).length} lines`;
    }

    function updateUnifiedView(diff) {
        const unifiedLineNumbers = document.getElementById('unified-line-numbers');
        const unifiedCodeContent = document.getElementById('unified-code-content');
        
        let unifiedHTML = '';
        let lineNumHTML = '';
        let lineNum = 1;
        
        diff.forEach(item => {
            if (item.type === 'unchanged') {
                lineNumHTML += `<div class="line-num">${lineNum}</div>`;
                unifiedHTML += `<div class="code-line">${escapeHtml(item.original)}</div>`;
                lineNum++;
            } else if (item.type === 'removed') {
                lineNumHTML += `<div class="line-num line-removed">-</div>`;
                unifiedHTML += `<div class="code-line line-removed">- ${escapeHtml(item.original)}</div>`;
            } else if (item.type === 'added') {
                lineNumHTML += `<div class="line-num line-added">+</div>`;
                unifiedHTML += `<div class="code-line line-added">+ ${escapeHtml(item.improved)}</div>`;
            } else if (item.type === 'changed') {
                lineNumHTML += `<div class="line-num line-removed">-</div>`;
                unifiedHTML += `<div class="code-line line-removed">- ${escapeHtml(item.original)}</div>`;
                lineNumHTML += `<div class="line-num line-added">+</div>`;
                unifiedHTML += `<div class="code-line line-added">+ ${escapeHtml(item.improved)}</div>`;
            }
        });
        
        unifiedLineNumbers.innerHTML = lineNumHTML;
        unifiedCodeContent.innerHTML = unifiedHTML;
    }

    function updateDiffStats(diff) {
        const added = diff.filter(d => d.type === 'added' || d.type === 'changed').length;
        const removed = diff.filter(d => d.type === 'removed' || d.type === 'changed').length;
        
        document.getElementById('diff-stats-text').innerHTML = `
            <span class="stat-added">+${added}</span> 
            <span class="stat-removed">-${removed}</span> 
            lines changed
        `;
    }

    function toggleDiffMode() {
        const sideBySide = document.getElementById('side-by-side-view');
        const unified = document.getElementById('unified-view');
        const modeText = document.getElementById('diff-mode-text');
        
        if (sideBySide.classList.contains('active')) {
            sideBySide.classList.remove('active');
            unified.classList.add('active');
            modeText.textContent = 'Switch to Side-by-Side';
        } else {
            unified.classList.remove('active');
            sideBySide.classList.add('active');
            modeText.textContent = 'Switch to Unified View';
        }
    }

    function closeCompare() {
        document.getElementById('compare-modal').style.display = 'none';
    }

    function saveVersion() {
        document.getElementById('save-modal').style.display = 'block';
    }

    function closeSave() {
        document.getElementById('save-modal').style.display = 'none';
    }

    function confirmSave() {
        const devComments = document.getElementById('dev-comments').value;
        const setActive = document.getElementById('set-active').checked;

        fetch('{{ url_for("widgets.save_version", slug=widget.slug) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: currentImprovedCode,
                prompt_used: currentPrompt,
                improvement_type: currentType,
                dev_comments: devComments,
                set_active: setActive
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Version saved successfully!');
                if (setActive) {
                    window.location.href = '{{ url_for("widgets.view_widget", slug=widget.slug) }}';
                } else {
                    location.reload();
                }
            } else {
                alert('Failed to save version: ' + data.error);
            }
        })
        .catch(error => {
            alert('Failed to save version: ' + error.message);
        });

        closeSave();
    }

    function testVersion() {
        // Open a new window/tab to test the widget with the improved code
        const testForm = document.createElement('form');
        testForm.method = 'POST';
        testForm.action = '{{ url_for("widgets.test_version", slug=widget.slug) }}';
        testForm.target = '_blank';

        const codeInput = document.createElement('input');
        codeInput.type = 'hidden';
        codeInput.name = 'code';
        codeInput.value = currentImprovedCode;

        testForm.appendChild(codeInput);
        document.body.appendChild(testForm);
        testForm.submit();
        document.body.removeChild(testForm);
    }
</script>
{% endblock %}