
{% extends "layouts/" + theme_layout + ".html" %}

{% block title %}Improve Widget: {{ widget.title }} - Atacama{% endblock %}

{% block content %}
<div class="container">
    <h1>Improve Widget: {{ widget.title }}</h1>
    
    <div class="improvement-header">
        <a href="{{ url_for('widgets.edit_widget', slug=widget.slug) }}" class="button secondary">Back to Edit</a>
        <a href="{{ url_for('widgets.view_widget', slug=widget.slug) }}" class="button">View Widget</a>
    </div>

    <div class="improvement-workflow">
        <!-- Version Selection -->
        <div class="version-selection">
            <h3>Starting Version</h3>
            <select id="base-version" name="base_version">
                <option value="current">Current Code ({{ widget.title }})</option>
                {% for version in widget.versions %}
                    <option value="{{ version.id }}" 
                            {% if version.id == widget.active_version_id %}selected{% endif %}>
                        Version {{ version.version_number }} 
                        {% if version.improvement_type %}({{ version.improvement_type }}){% endif %}
                        - {{ version.created_at.strftime('%m/%d %H:%M') }}
                        {% if not version.is_working %} ‚ö†Ô∏è{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Improvement Options -->
        <div class="improvement-options">
            <h3>Improvement Type</h3>
            
            <!-- Canned Actions -->
            <div class="canned-actions">
                <h4>Quick Improvements</h4>
                <div class="action-buttons">
                    <button type="button" class="button canned-action" 
                            data-type="fullscreen" 
                            data-prompt="Improve this React widget to work better in full-screen mode...">
                        üì± Better Full-Screen Mode
                    </button>
                    <button type="button" class="button canned-action" 
                            data-type="global_settings" 
                            data-prompt="Enhance this React widget to support global application settings...">
                        üé® Global Settings Support
                    </button>
                    <button type="button" class="button canned-action" 
                            data-type="accessibility" 
                            data-prompt="Improve the accessibility of this React widget...">
                        ‚ôø Accessibility Improvements
                    </button>
                    <button type="button" class="button canned-action" 
                            data-type="mobile" 
                            data-prompt="Optimize this React widget for mobile devices...">
                        üì± Mobile Optimization
                    </button>
                </div>
            </div>

            <!-- Custom Prompt -->
            <div class="custom-prompt">
                <h4>Custom Improvement</h4>
                <textarea id="custom-prompt" rows="4" 
                          placeholder="Describe how you'd like to improve this widget..."></textarea>
                <button type="button" class="button primary" onclick="improveWidget('custom')">
                    üöÄ Improve Widget
                </button>
            </div>
        </div>

        <!-- Progress Area -->
        <div id="improvement-progress" class="improvement-progress" style="display: none;">
            <h3>Processing...</h3>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <p id="progress-text">Analyzing widget code...</p>
        </div>

        <!-- Results Area -->
        <div id="improvement-results" class="improvement-results" style="display: none;">
            <h3>Improvement Results</h3>
            <div class="results-content">
                <div class="result-actions">
                    <button type="button" class="button primary" onclick="saveVersion()">
                        üíæ Save This Version
                    </button>
                    <button type="button" class="button secondary" onclick="compareCode()">
                        üìä Compare Changes
                    </button>
                    <button type="button" class="button" onclick="testVersion()">
                        üß™ Test Version
                    </button>
                </div>
                <div class="code-preview">
                    <h4>Improved Code:</h4>
                    <textarea id="improved-code" rows="20" readonly></textarea>
                </div>
                <div class="ai-notes">
                    <h4>AI Notes:</h4>
                    <div id="ai-response"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Code Comparison Modal -->
<div id="compare-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeCompare()">&times;</span>
        <h2>Code Comparison</h2>
        <div class="comparison-view">
            <div class="code-column">
                <h3>Original Code</h3>
                <textarea id="original-code" readonly></textarea>
            </div>
            <div class="code-column">
                <h3>Improved Code</h3>
                <textarea id="comparison-improved-code" readonly></textarea>
            </div>
        </div>
    </div>
</div>

<!-- Version Save Modal -->
<div id="save-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeSave()">&times;</span>
        <h2>Save Version</h2>
        <form id="save-version-form">
            <div class="form-group">
                <label for="dev-comments">Developer Comments:</label>
                <textarea id="dev-comments" name="dev_comments" rows="3" 
                          placeholder="Notes about this version..."></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="set-active" name="set_active">
                    Set as active version
                </label>
            </div>
            <div class="form-actions">
                <button type="button" class="button primary" onclick="confirmSave()">Save Version</button>
                <button type="button" class="button secondary" onclick="closeSave()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<style>
    .improvement-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
    }

    .improvement-workflow {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .version-selection select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
    }

    .canned-actions .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }

    .canned-action {
        text-align: left;
        padding: 1rem;
        height: auto;
        white-space: normal;
    }

    .custom-prompt textarea {
        width: 100%;
        margin-bottom: 1rem;
        padding: 0.5rem;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        font-family: inherit;
    }

    .improvement-progress {
        text-align: center;
        padding: 2rem;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        background: var(--color-background);
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--color-background-secondary);
        border-radius: 4px;
        overflow: hidden;
        margin: 1rem 0;
    }

    .progress-fill {
        height: 100%;
        background: var(--color-primary);
        width: 0%;
        transition: width 0.3s ease;
        animation: progress-animation 2s infinite;
    }

    @keyframes progress-animation {
        0% { width: 0%; }
        50% { width: 70%; }
        100% { width: 100%; }
    }

    .improvement-results {
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        background: var(--color-background);
    }

    .result-actions {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .code-preview textarea {
        width: 100%;
        font-family: 'Courier New', Courier, monospace;
        font-size: 14px;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        padding: 1rem;
    }

    .ai-notes {
        margin-top: 1.5rem;
        padding: 1rem;
        background: var(--color-background-secondary);
        border-radius: var(--border-radius);
    }

    .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: var(--color-background);
        margin: 5% auto;
        padding: 2rem;
        border: 1px solid var(--color-border);
        width: 90%;
        max-width: 1200px;
        border-radius: var(--border-radius);
        position: relative;
        max-height: 80vh;
        overflow-y: auto;
    }

    .comparison-view {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }

    .code-column textarea {
        width: 100%;
        height: 400px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 12px;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        padding: 1rem;
    }

    .close {
        position: absolute;
        right: 1rem;
        top: 1rem;
        font-size: 2rem;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover {
        color: var(--color-error);
    }

    @media (max-width: 768px) {
        .comparison-view {
            grid-template-columns: 1fr;
        }
        
        .result-actions {
            flex-direction: column;
        }
        
        .improvement-header {
            flex-direction: column;
            gap: 1rem;
        }
    }
</style>

<script>
    let currentImprovedCode = '';
    let currentPrompt = '';
    let currentType = '';
    let originalCode = '';

    // Set up canned action buttons
    document.querySelectorAll('.canned-action').forEach(button => {
        button.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            const prompt = this.getAttribute('data-prompt');
            improveWidget(type, prompt);
        });
    });

    function getSelectedVersionCode() {
        const versionSelect = document.getElementById('base-version');
        const selectedValue = versionSelect.value;
        
        if (selectedValue === 'current') {
            return `{{ widget.code|safe|replace('\n', '\\n')|replace('"', '\\"') }}`;
        } else {
            // For now, we'll use current code - in real implementation, 
            // this would fetch the specific version code via AJAX
            return `{{ widget.code|safe|replace('\n', '\\n')|replace('"', '\\"') }}`;
        }
    }

    function improveWidget(type, prompt = null) {
        currentType = type;
        originalCode = getSelectedVersionCode();
        
        if (type === 'custom') {
            prompt = document.getElementById('custom-prompt').value;
            if (!prompt.trim()) {
                alert('Please enter a description of how to improve the widget.');
                return;
            }
        }
        
        currentPrompt = prompt;
        
        // Show progress
        document.getElementById('improvement-progress').style.display = 'block';
        document.getElementById('improvement-results').style.display = 'none';
        
        // Update progress text
        const progressText = document.getElementById('progress-text');
        const progressFill = document.querySelector('.progress-fill');
        
        progressText.textContent = 'Sending request to AI...';
        progressFill.style.width = '30%';
        
        setTimeout(() => {
            progressText.textContent = 'AI is analyzing and improving code...';
            progressFill.style.width = '70%';
        }, 1000);
        
        // Make the improvement request
        fetch('{{ url_for("widgets.improve_widget", slug=widget.slug) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                base_version: document.getElementById('base-version').value,
                prompt: prompt,
                improvement_type: type
            })
        })
        .then(response => response.json())
        .then(data => {
            progressText.textContent = 'Processing results...';
            progressFill.style.width = '100%';
            
            setTimeout(() => {
                showResults(data);
            }, 500);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to improve widget: ' + error.message);
            document.getElementById('improvement-progress').style.display = 'none';
        });
    }

    function showResults(data) {
        document.getElementById('improvement-progress').style.display = 'none';
        document.getElementById('improvement-results').style.display = 'block';
        
        if (data.success) {
            currentImprovedCode = data.improved_code;
            document.getElementById('improved-code').value = data.improved_code;
            document.getElementById('ai-response').innerHTML = `
                <p><strong>Improvement successful!</strong></p>
                <p>AI used: ${data.ai_model || 'OpenAI'}</p>
                <p>Type: ${currentType}</p>
                ${data.full_response ? `<details><summary>Full AI Response</summary><pre>${data.full_response}</pre></details>` : ''}
            `;
        } else {
            document.getElementById('ai-response').innerHTML = `
                <p><strong>Error:</strong> ${data.error}</p>
                <p>The original code has been preserved.</p>
            `;
            currentImprovedCode = originalCode;
            document.getElementById('improved-code').value = originalCode;
        }
    }

    function compareCode() {
        document.getElementById('original-code').value = originalCode;
        document.getElementById('comparison-improved-code').value = currentImprovedCode;
        document.getElementById('compare-modal').style.display = 'block';
    }

    function closeCompare() {
        document.getElementById('compare-modal').style.display = 'none';
    }

    function saveVersion() {
        document.getElementById('save-modal').style.display = 'block';
    }

    function closeSave() {
        document.getElementById('save-modal').style.display = 'none';
    }

    function confirmSave() {
        const devComments = document.getElementById('dev-comments').value;
        const setActive = document.getElementById('set-active').checked;
        
        fetch('{{ url_for("widgets.save_version", slug=widget.slug) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: currentImprovedCode,
                prompt_used: currentPrompt,
                improvement_type: currentType,
                dev_comments: devComments,
                set_active: setActive
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Version saved successfully!');
                if (setActive) {
                    window.location.href = '{{ url_for("widgets.view_widget", slug=widget.slug) }}';
                } else {
                    location.reload();
                }
            } else {
                alert('Failed to save version: ' + data.error);
            }
        })
        .catch(error => {
            alert('Failed to save version: ' + error.message);
        });
        
        closeSave();
    }

    function testVersion() {
        // Open a new window/tab to test the widget with the improved code
        const testForm = document.createElement('form');
        testForm.method = 'POST';
        testForm.action = '{{ url_for("widgets.test_version", slug=widget.slug) }}';
        testForm.target = '_blank';
        
        const codeInput = document.createElement('input');
        codeInput.type = 'hidden';
        codeInput.name = 'code';
        codeInput.value = currentImprovedCode;
        
        testForm.appendChild(codeInput);
        document.body.appendChild(testForm);
        testForm.submit();
        document.body.removeChild(testForm);
    }
</script>
{% endblock %}
